{
  "_version": "5.0.0",
  "_changelog": "v5.0.0: Switch to batchscript collection to avoid SSH rate limiting",
  "name": "Juniper_EVPN_VTEPs",
  "displayName": "EVPN VTEPs",
  "description": "Monitors remote VTEP peers on Juniper QFX switches for VXLAN fabric mesh health.",
  "appliesTo": "hasCategory(\"Juniper\") && system.sysinfo =~ \"QFX\"",
  "technology": "Requires SSH access. Discovers remote VTEPs from VXLAN tunnel endpoints and monitors reachability.",
  "tags": "juniper,evpn,vxlan,vtep,qfx,fabric,data-plane",
  "group": "",
  "hasMultiInstances": true,
  "useWildValueAsUUID": false,
  "collectInterval": 300,
  "collectMethod": "batchscript",
  "collectorAttribute": {
    "name": "batchscript",
    "groovyScript": "// VTEP Batch Collection Script v5.0.0\n// Uses single SSH connection for all instances to avoid rate limiting\nimport com.jcraft.jsch.JSch\nimport com.santaba.agent.util.Settings\n\ndef host = hostProps.get('system.hostname')\ndef user = hostProps.get('ssh.user')\ndef pass = hostProps.get('ssh.pass')\ndef port = hostProps.get('ssh.port')?.toInteger() ?: 22\ndef timeout = 30000\n\nif (!user) { println 'Error: ssh.user not set'; return 1 }\nif (!host) { println 'Error: system.hostname not set'; return 1 }\n\ndef runCommand(session, cmd) {\n    def channel = session.openChannel('exec')\n    channel.setCommand(cmd)\n    def output = channel.getInputStream()\n    channel.connect()\n    def result = output.text\n    channel.disconnect()\n    return result\n}\n\ntry {\n    def jsch = new JSch()\n    def session = jsch.getSession(user, host, port)\n    session.setConfig('StrictHostKeyChecking', 'no')\n    def authMethod = Settings.getSetting(Settings.SSH_PREFEREDAUTHENTICATION, Settings.DEFAULT_SSH_PREFEREDAUTHENTICATION)\n    session.setConfig('PreferredAuthentications', authMethod)\n    session.setTimeout(timeout)\n    if (pass) { session.setPassword(pass) }\n    session.connect()\n    \n    // Get VTEP summary (same as discovery)\n    def output = runCommand(session, 'show ethernet-switching vxlan-tunnel-end-point remote summary | no-more')\n    \n    session.disconnect()\n    \n    // Parse VTEPs and count occurrences\n    def vtepCounts = [:]\n    output.eachLine { line ->\n        def match = line =~ /^\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+)\\s+/\n        if (match.find()) {\n            def vtepIp = match.group(1)\n            vtepCounts[vtepIp] = (vtepCounts[vtepIp] ?: 0) + 1\n        }\n    }\n    \n    // Output in batch format: wildvalue.datapoint=value\n    vtepCounts.each { vtepIp, count ->\n        println \"${vtepIp}.Status=1\"\n        println \"${vtepIp}.TunnelCount=${count}\"\n    }\n    \n} catch (Exception e) {\n    println 'Error: ' + e.message\n    return 1\n}\n\nreturn 0",
    "scriptType": "embed",
    "linuxCmdline": "",
    "linuxScript": "",
    "windowsCmdline": "",
    "windowsScript": ""
  },
  "enableAutoDiscovery": true,
  "autoDiscoveryConfig": {
    "persistentInstance": true,
    "disableInstance": false,
    "deleteInactiveInstance": true,
    "showDeletedInstanceDays": 0,
    "instanceAutoGroupMethod": "none",
    "instanceAutoGroupMethodParams": "",
    "scheduleInterval": 60,
    "method": {
      "name": "ad_script",
      "type": "embeded",
      "groovyScript": "// VTEP Discovery Script v5.0.0\n// Production version\nimport com.jcraft.jsch.JSch\nimport com.santaba.agent.util.Settings\n\ndef host = hostProps.get('system.hostname')\ndef user = hostProps.get('ssh.user')\ndef pass = hostProps.get('ssh.pass')\ndef port = hostProps.get('ssh.port')?.toInteger() ?: 22\ndef timeout = 30000\n\nif (!user) { println 'Error: ssh.user not set'; return 1 }\nif (!host) { println 'Error: system.hostname not set'; return 1 }\n\ndef runCommand(session, cmd) {\n    def channel = session.openChannel('exec')\n    channel.setCommand(cmd)\n    def output = channel.getInputStream()\n    channel.connect()\n    def result = output.text\n    channel.disconnect()\n    return result\n}\n\ntry {\n    def jsch = new JSch()\n    def session = jsch.getSession(user, host, port)\n    session.setConfig('StrictHostKeyChecking', 'no')\n    def authMethod = Settings.getSetting(Settings.SSH_PREFEREDAUTHENTICATION, Settings.DEFAULT_SSH_PREFEREDAUTHENTICATION)\n    session.setConfig('PreferredAuthentications', authMethod)\n    session.setTimeout(timeout)\n    if (pass) { session.setPassword(pass) }\n    session.connect()\n    \n    // Get VTEP summary\n    def output = runCommand(session, 'show ethernet-switching vxlan-tunnel-end-point remote summary | no-more')\n    \n    session.disconnect()\n    \n    // Parse VTEPs - lines starting with whitespace then IP\n    def vtepSet = [] as Set\n    output.eachLine { line ->\n        def match = line =~ /^\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+)\\s+/\n        if (match.find()) {\n            def vtepIp = match.group(1)\n            if (!vtepSet.contains(vtepIp)) {\n                vtepSet.add(vtepIp)\n                println \"${vtepIp}##VTEP-${vtepIp}##Remote VTEP####auto.vtep.ip=${vtepIp}\"\n            }\n        }\n    }\n    \n} catch (Exception e) {\n    println 'Error: ' + e.message\n}\n\nreturn 0",
      "linuxCmdline": "",
      "linuxScript": "",
      "windowsCmdline": "",
      "windowsScript": ""
    },
    "filters": []
  },
  "dataPoints": [
    {
      "name": "Status",
      "description": "VTEP reachability status (1=up, 0=down)",
      "alertTransitionInterval": 1,
      "alertClearTransitionInterval": 1,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "##WILDVALUE##.Status",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "!= 1",
      "alertExprNote": "Remote VTEP is unreachable",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "TunnelCount",
      "description": "Number of tunnel entries for this VTEP",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "##WILDVALUE##.TunnelCount",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    }
  ],
  "graphs": [
    {
      "name": "VTEP Status",
      "title": "VTEP Status",
      "verticalLabel": "Status",
      "rigid": false,
      "maxValue": "1",
      "minValue": "0",
      "displayPrio": 1,
      "timescale": "1day",
      "base1024": false,
      "dataPoints": [
        {
          "name": "Status",
          "consolidateFunc": 1,
          "aggregateMethod": "min",
          "aggregateFunc": "min"
        }
      ]
    },
    {
      "name": "Tunnel Distribution",
      "title": "Tunnels per VTEP",
      "verticalLabel": "Count",
      "rigid": false,
      "maxValue": "NaN",
      "minValue": "0",
      "displayPrio": 2,
      "timescale": "1day",
      "base1024": false,
      "dataPoints": [
        {
          "name": "TunnelCount",
          "consolidateFunc": 1,
          "aggregateMethod": "sum",
          "aggregateFunc": "sum"
        }
      ]
    }
  ]
}
