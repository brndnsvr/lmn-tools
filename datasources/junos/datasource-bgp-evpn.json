{
  "_version": "1.0.0",
  "_changelog": "v1.0.0: Initial BGP EVPN peer monitoring",
  "name": "Juniper_EVPN_BGP",
  "displayName": "EVPN BGP Peers",
  "description": "Monitors BGP EVPN peer sessions on Juniper QFX switches for control plane health and route exchange.",
  "appliesTo": "hasCategory(\"Juniper\") && system.sysinfo =~ \"QFX\"",
  "technology": "Requires SSH access. Discovers BGP peers with EVPN address family and monitors session state.",
  "tags": "juniper,evpn,bgp,qfx,fabric,control-plane",
  "group": "",
  "hasMultiInstances": true,
  "useWildValueAsUUID": false,
  "collectInterval": 300,
  "collectMethod": "script",
  "collectorAttribute": {
    "name": "script",
    "groovyScript": "// BGP EVPN Collection Script\n// v1.0.0: Monitor BGP EVPN peer state and prefixes\nimport com.jcraft.jsch.JSch\nimport com.santaba.agent.util.Settings\n\ndef host = hostProps.get('system.hostname')\ndef user = hostProps.get('ssh.user')\ndef pass = hostProps.get('ssh.pass')\ndef port = hostProps.get('ssh.port')?.toInteger() ?: 22\ndef timeout = 30000\n\ndef peerIp = instanceProps.get('wildvalue')\n\nif (!user) { println 'Error: ssh.user not set'; return 1 }\nif (!host) { println 'Error: system.hostname not set'; return 1 }\nif (!peerIp) { println 'Error: wildvalue (peer IP) not set'; return 1 }\n\ndef peerState = 0\ndef prefixesReceived = 0\ndef prefixesActive = 0\ndef messagesIn = 0\ndef messagesOut = 0\ndef flapCount = 0\n\n// State mapping: Established=6 (only good state)\ndef stateMap = [\n    'Idle': 1,\n    'Connect': 2,\n    'Active': 3,\n    'OpenSent': 4,\n    'OpenConfirm': 5,\n    'Established': 6\n]\n\ndef runCommand(session, cmd) {\n    def channel = session.openChannel('exec')\n    channel.setCommand(cmd)\n    def output = channel.getInputStream()\n    channel.connect()\n    def result = output.text\n    channel.disconnect()\n    return result\n}\n\ntry {\n    def jsch = new JSch()\n    def session = jsch.getSession(user, host, port)\n    session.setConfig('StrictHostKeyChecking', 'no')\n    def authMethod = Settings.getSetting(Settings.SSH_PREFEREDAUTHENTICATION, Settings.DEFAULT_SSH_PREFEREDAUTHENTICATION)\n    session.setConfig('PreferredAuthentications', authMethod)\n    session.setTimeout(timeout)\n    if (pass) { session.setPassword(pass) }\n    session.connect()\n    \n    // Get BGP neighbor details\n    def output = runCommand(session, \"show bgp neighbor ${peerIp} | no-more\")\n    \n    session.disconnect()\n    \n    // Parse peer state\n    def stateMatch = output =~ /State:\\s*(\\w+)/\n    if (stateMatch.find()) {\n        def stateStr = stateMatch.group(1)\n        peerState = stateMap[stateStr] ?: 0\n    }\n    \n    // Parse EVPN prefixes (bgp.evpn.0 table)\n    def evpnMatch = output =~ /bgp\\.evpn\\.0:\\s*(\\d+)\\/(\\d+)/\n    if (evpnMatch.find()) {\n        prefixesActive = evpnMatch.group(1).toInteger()\n        prefixesReceived = evpnMatch.group(2).toInteger()\n    }\n    \n    // Parse messages\n    def msgInMatch = output =~ /Input messages:\\s*Total\\s*(\\d+)/\n    if (msgInMatch.find()) {\n        messagesIn = msgInMatch.group(1).toLong()\n    }\n    \n    def msgOutMatch = output =~ /Output messages:\\s*Total\\s*(\\d+)/\n    if (msgOutMatch.find()) {\n        messagesOut = msgOutMatch.group(1).toLong()\n    }\n    \n    // Parse flap count\n    def flapMatch = output =~ /Flaps\\s*(\\d+)/\n    if (flapMatch.find()) {\n        flapCount = flapMatch.group(1).toInteger()\n    }\n    \n} catch (Exception e) {\n    println 'Error: ' + e.message\n    peerState = 0\n}\n\nprintln \"PeerState=${peerState}\"\nprintln \"PrefixesReceived=${prefixesReceived}\"\nprintln \"PrefixesActive=${prefixesActive}\"\nprintln \"MessagesIn=${messagesIn}\"\nprintln \"MessagesOut=${messagesOut}\"\nprintln \"FlapCount=${flapCount}\"\n\nreturn 0",
    "scriptType": "embed",
    "linuxCmdline": "",
    "linuxScript": "",
    "windowsCmdline": "",
    "windowsScript": ""
  },
  "enableAutoDiscovery": true,
  "autoDiscoveryConfig": {
    "persistentInstance": true,
    "disableInstance": false,
    "deleteInactiveInstance": true,
    "showDeletedInstanceDays": 0,
    "instanceAutoGroupMethod": "none",
    "instanceAutoGroupMethodParams": "",
    "scheduleInterval": 60,
    "method": {
      "name": "ad_script",
      "type": "embeded",
      "groovyScript": "// BGP EVPN Discovery Script\n// v1.0.0: Discover BGP peers with EVPN address family\nimport com.jcraft.jsch.JSch\nimport com.santaba.agent.util.Settings\n\ndef host = hostProps.get('system.hostname')\ndef user = hostProps.get('ssh.user')\ndef pass = hostProps.get('ssh.pass')\ndef port = hostProps.get('ssh.port')?.toInteger() ?: 22\ndef timeout = 30000\n\nif (!user) { println 'Error: ssh.user not set'; return 1 }\nif (!host) { println 'Error: system.hostname not set'; return 1 }\n\ndef runCommand(session, cmd) {\n    def channel = session.openChannel('exec')\n    channel.setCommand(cmd)\n    def output = channel.getInputStream()\n    channel.connect()\n    def result = output.text\n    channel.disconnect()\n    return result\n}\n\ntry {\n    def jsch = new JSch()\n    def session = jsch.getSession(user, host, port)\n    session.setConfig('StrictHostKeyChecking', 'no')\n    def authMethod = Settings.getSetting(Settings.SSH_PREFEREDAUTHENTICATION, Settings.DEFAULT_SSH_PREFEREDAUTHENTICATION)\n    session.setConfig('PreferredAuthentications', authMethod)\n    session.setTimeout(timeout)\n    if (pass) { session.setPassword(pass) }\n    session.connect()\n    \n    // Get BGP summary\n    def output = runCommand(session, 'show bgp summary | no-more')\n    \n    session.disconnect()\n    \n    // Parse BGP peers with EVPN table\n    def currentPeer = null\n    def currentAS = null\n    def currentState = null\n    def foundCount = 0\n    \n    output.eachLine { line ->\n        // Match peer line: IP AS InPkt OutPkt OutQ Flaps Last State\n        def peerMatch = line =~ /^(\\d+\\.\\d+\\.\\d+\\.\\d+)\\s+(\\d+)\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\d+\\s+\\S+\\s+(\\S+)/\n        if (peerMatch.find()) {\n            currentPeer = peerMatch.group(1)\n            currentAS = peerMatch.group(2)\n            currentState = peerMatch.group(3)\n        }\n        \n        // Match EVPN table reference (indented line after peer)\n        def evpnMatch = line =~ /^\\s+bgp\\.evpn\\.0:\\s*(\\d+)\\/(\\d+)/\n        if (evpnMatch.find() && currentPeer) {\n            def activeRoutes = evpnMatch.group(1)\n            def receivedRoutes = evpnMatch.group(2)\n            def stateDisplay = currentState == 'Establ' ? 'Established' : currentState\n            println \"${currentPeer}##BGP-${currentPeer}##AS${currentAS} (${stateDisplay})####auto.peer.ip=${currentPeer}&auto.peer.asn=${currentAS}&auto.evpn.routes=${receivedRoutes}\"\n            foundCount++\n            currentPeer = null  // Reset to avoid duplicate output\n        }\n    }\n    \n    if (foundCount == 0) {\n        // Check if BGP is running but no EVPN peers\n        if (output.contains('Peer') || output.contains('bgp')) {\n            println \"DEBUG##No-EVPN-Peers##BGP running but no peers with bgp.evpn.0 table####auto.raw.len=${output.length()}\"\n        } else {\n            println \"DEBUG##No-BGP##BGP not configured or no output####auto.raw.len=${output.length()}\"\n        }\n    }\n    \n} catch (Exception e) {\n    println \"Error: ${e.class.simpleName} - ${e.message}\"\n    return 1\n}\n\nreturn 0",
      "linuxCmdline": "",
      "linuxScript": "",
      "windowsCmdline": "",
      "windowsScript": ""
    },
    "filters": []
  },
  "dataPoints": [
    {
      "name": "PeerState",
      "description": "BGP peer state (6=Established, alert on anything else)",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "PeerState",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "!= 6",
      "alertExprNote": "BGP EVPN peer not in Established state",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "PrefixesReceived",
      "description": "Number of EVPN prefixes received from peer",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "PrefixesReceived",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "PrefixesActive",
      "description": "Number of active EVPN prefixes from peer",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "PrefixesActive",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "MessagesIn",
      "description": "Total BGP messages received",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "MessagesIn",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "MessagesOut",
      "description": "Total BGP messages sent",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "MessagesOut",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    },
    {
      "name": "FlapCount",
      "description": "Number of times the BGP session has flapped",
      "alertTransitionInterval": 0,
      "alertClearTransitionInterval": 0,
      "type": 2,
      "dataType": 7,
      "maxDigits": 4,
      "postProcessorMethod": "namevalue",
      "postProcessorParam": "FlapCount",
      "rawDataFieldName": "output",
      "maxValue": "",
      "minValue": "",
      "userParam1": "",
      "userParam2": "",
      "userParam3": "",
      "alertForNoData": 1,
      "alertExpr": "",
      "alertExprNote": "",
      "alertSubject": "",
      "alertBody": ""
    }
  ],
  "graphs": [
    {
      "name": "Peer State",
      "title": "BGP Peer State",
      "verticalLabel": "State",
      "rigid": false,
      "maxValue": "6",
      "minValue": "0",
      "displayPrio": 1,
      "timescale": "1day",
      "base1024": false,
      "dataPoints": [
        {
          "name": "PeerState",
          "consolidateFunc": 1,
          "aggregateMethod": "min",
          "aggregateFunc": "min"
        }
      ]
    },
    {
      "name": "EVPN Prefixes",
      "title": "EVPN Prefixes",
      "verticalLabel": "Count",
      "rigid": false,
      "maxValue": "NaN",
      "minValue": "0",
      "displayPrio": 2,
      "timescale": "1day",
      "base1024": false,
      "dataPoints": [
        {
          "name": "PrefixesReceived",
          "consolidateFunc": 1,
          "aggregateMethod": "sum",
          "aggregateFunc": "sum"
        },
        {
          "name": "PrefixesActive",
          "consolidateFunc": 1,
          "aggregateMethod": "sum",
          "aggregateFunc": "sum"
        }
      ]
    },
    {
      "name": "BGP Messages",
      "title": "BGP Messages",
      "verticalLabel": "Messages",
      "rigid": false,
      "maxValue": "NaN",
      "minValue": "0",
      "displayPrio": 3,
      "timescale": "1day",
      "base1024": false,
      "dataPoints": [
        {
          "name": "MessagesIn",
          "consolidateFunc": 1,
          "aggregateMethod": "sum",
          "aggregateFunc": "sum"
        },
        {
          "name": "MessagesOut",
          "consolidateFunc": 1,
          "aggregateMethod": "sum",
          "aggregateFunc": "sum"
        }
      ]
    }
  ]
}
