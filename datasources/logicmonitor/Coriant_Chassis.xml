<?xml version="1.0" encoding="UTF-8"?>
<!--
Coriant Chassis DataSource for LogicMonitor
Single-instance DataSource using SCRIPT collection

Monitors chassis-level metrics (temperature, software state) on Coriant devices.

Required Device Properties:
  - netconf.user: NETCONF username
  - netconf.pass: NETCONF password
  - netconf.port: NETCONF port (default: 830)
-->
<DataSource>
  <name>Coriant_Chassis</name>
  <displayName>Coriant Chassis</displayName>
  <description>Monitors chassis-level metrics (temperature, altitude, software state) on Coriant optical transport devices via NETCONF</description>
  <group>Optical Transport</group>
  <hasMultiInstances>false</hasMultiInstances>

  <appliesTo>hasCategory("CoriantOptical") || system.sysoid == "REPLACE_WITH_OID"</appliesTo>

  <!-- Collection Configuration -->
  <dataPoints>
    <dataPoint>
      <name>ne_temperature</name>
      <description>Network element temperature in degrees Celsius</description>
      <dataType>7</dataType>
      <type>2</type>
      <alertExpr>&gt; 55 60 65</alertExpr>
      <alertExprNote>Alert on high temperature</alertExprNote>
      <alertTransitionInterval>3</alertTransitionInterval>
      <maxDigits>4</maxDigits>
    </dataPoint>
    <dataPoint>
      <name>ne_altitude</name>
      <description>Network element altitude in meters</description>
      <dataType>7</dataType>
      <type>2</type>
      <alertExpr></alertExpr>
      <maxDigits>4</maxDigits>
    </dataPoint>
    <dataPoint>
      <name>swload_active</name>
      <description>Active software load present (1=yes, 0=no)</description>
      <dataType>7</dataType>
      <type>2</type>
      <alertExpr>= 0 0 0</alertExpr>
      <alertExprNote>Alert if no active software load</alertExprNote>
      <alertTransitionInterval>3</alertTransitionInterval>
      <maxDigits>4</maxDigits>
    </dataPoint>
  </dataPoints>

  <collectMethod>script</collectMethod>
  <collectInterval>300</collectInterval>

  <collectScript><![CDATA[
// Coriant Chassis SCRIPT Collection
// Calls the Python collection script and outputs metrics

import com.santaba.agent.groovyapi.expect.Expect
import com.santaba.agent.groovyapi.snmp.Snmp
import com.santaba.agent.groovyapi.file.File

def hostname = hostProps.get("system.hostname")
def username = hostProps.get("netconf.user") ?: "admin"
def password = hostProps.get("netconf.pass") ?: ""
def port = hostProps.get("netconf.port") ?: "830"

// Path to Python script - adjust based on your collector installation
def scriptPath = "/usr/local/logicmonitor/lm-netconf-optical/scripts/coriant_chassis_collect.py"

def cmd = ["python3", scriptPath, hostname, username, password, "--port", port]

try {
    def process = cmd.execute()
    def stdout = new StringBuilder()
    def stderr = new StringBuilder()
    process.consumeProcessOutput(stdout, stderr)
    process.waitForOrKill(120000)  // 2 minute timeout

    if (process.exitValue() == 0) {
        // Output collection results (single-instance format: datapoint=value)
        println stdout.toString()
    } else {
        println "Collection failed: ${stderr.toString()}"
        return 1
    }
} catch (Exception e) {
    println "Error: ${e.message}"
    return 1
}

return 0
]]></collectScript>

  <!-- Graphs -->
  <graphs>
    <graph>
      <name>Temperature</name>
      <title>Chassis Temperature</title>
      <verticalLabel>Degrees C</verticalLabel>
      <lines>
        <line>
          <type>2</type>
          <legend>Temperature</legend>
          <dataPointName>ne_temperature</dataPointName>
          <color>red</color>
        </line>
      </lines>
    </graph>
  </graphs>
</DataSource>
